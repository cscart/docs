**********************
Служба доставки "СДЭК"
**********************

.. note::

    Для корректной работы сначала настройте налоги с помощью модуля :doc:`/user_guide/addons/rus_taxes/index`.

.. contents::
   :backlinks: none
   :local:

Настройка способа доставки
==========================

#. Заключите договор с менеджером СДЭК.

    При подписании договора автоматически создаётся личный кабинет СДЭК.

#. Установите модуль "Служба доставки — СДЭК".

#. Создайте :doc:`новый способ доставки </user_guide/shipping_and_taxes/shipping_methods/add_shipping_method>` и задайте некоторые обязательные свойства способа доставки:

   * На вкладке **Общее**:
   
     * **Название** — введите название способа доставки, которое покупатель увидит при оформлении заказа; например, *СДЭК*.

     * **Расчёт тарифа** — выберите вариант *СДЭК* как один из методов расчёта *в реальном времени (автоматически)*.

       .. fancybox:: img/sdek_shippings_01.png
           :alt: Вкладка Общее способа доставки СДЭК
   
   * На вкладке **Настроить**:

     * **Логин для доступа к серверу расчетов**

     * **Пароль для доступа к серверу расчетов**
    
       .. important::

           Поля "логин" и "пароль" — это API-ключи. Получить их можно в личном кабинете СДЭК, вкладка "Интеграция".

     * **Количество дней, через сколько будет произведена планируемая отправка заказа**
     
     * **Страна**
     
     * **Регион**

     * **Город-отправитель**

     * **ID города** — заполняется автоматически при нажатии на ссылку "Получить ID города". Определение ID города зависит от "Страны" в "Настройки" - "Компания".

     * **Почтовый индекс города-отправителя** — заполнять не обязательно, если задан город-отправитель.

     * **Выбор доступных тарифов** — у СДЭК есть `множество тарифов <https://www.cdek.ru/ru/individuals/tariffs>`_. Выбор тарифа влияет на стоимость доставки. 

     * **Ширина упаковки, см**

     * **Высота упаковки, см**

     * **Длина упаковки, см**

       .. fancybox:: img/sdek_shippings_02.png
           :alt: sdek

#. Проверьте работу автоматического расчёта.

   .. fancybox:: img/sdek_shippings_03.png
       :alt: sdek

   Теперь на витрине должен отображаться новый способ доставки, которым сможет воспользоваться покупатель. Если выбран один из тарифов "Склад — Склад", то покупатели увидят карту и смогут выбрать подходящий пункт выдачи заказов.

   .. fancybox:: img/sdek_pickup_2.png
       :alt: Пункты самовывоза в СДЭК.

   .. fancybox:: img/sdek_pickup_1.png
       :alt: Список пунктов выдачи заказов СДЭК со строкой поиска.

Передача информации о заказе в СДЭК
===================================

#. Откройте страницу **Заказы → Все заказы**.

#. Найдите и откройте заказ, информацию о котором нужно передать в СДЭК.

#. Сначала нужно создать отгрузку в CS-Cart. Для этого нажмите **Создать отдельную отгрузку**.

   .. fancybox:: img/sdek_order_details.png
       :alt: Отгрузки для СДЭК в CS-Cart создаются на странице заказа.

#. Заполните обязательные поля об отгрузке в появившемся окне:

   * **Способ доставки** — выберите способ доставки, который мы создали для СДЭК в п.3 настройки способа доставки.

   * **Перевозчик** — выберите вариант *СДЭК*.

     .. fancybox:: img/create_shipment_for_sdek.png
         :alt: Страница создания отгрузки в CS-Cart.

#. Нажмите кнопку **Создать**.

   .. hint::

       Не рекомендуем на этом этапе отправлять покупателю письмо о создании отгрузки. Это лучше сделать чуть позже, в шаге 7 — так мы отправим одно уведомление вместо двух, а в уведомлении уже будет номер отслеживания от СДЭК.

#. После того, как отгрузка будет создана, на странице заказа появится кнопка **Оформить отгрузку**. Нажмите на неё.

   .. fancybox:: img/create_sdek_shipment.png
       :alt: Создание отгрузки для СДЭК в CS-Cart.

#. Откроется всплывающее окно, в котором вы сможете оформить отгрузку в СДЭК. В окне есть несколько вкладок:

   * Вкладка **Общее**:

     * **Адрес доставки** — адрес покупателя (ecли для способа доставки СДЭК выбран тариф *"Склад — Дверь"*) или список пунктов выдачи заказов (ecли для способа доставки СДЭК выбран тариф *"Склад — Склад"*).

     * **Номер посылки** — номер упаковки, который будет присвоен посылке.

     * **Стоимость доставки** — сумма, которую покупатель оплатит за доставку; рассчитывается автоматически на основе товаров в отгрузке; данную стоимость можно изменять.

     * **Комментарий** — комментарий к заказу, который необходимо передать в службу доставки СДЭК.

     * **Включить стоимость товара** — поставьте галочку, если хотите включить стоимость товара в наложенный платеж. Если включена эта настройка и наложенный платёж, то стоимость наложенного платежа будет складываться из стоимости товара и стоимости, указанной в поле **Наложенный платеж**.

     * **Включить наложенный платеж** — поставьте галочку, если хотите, чтобы покупатель при получении заказа уплатил сумму из поля **Наложенный платеж**. Иначе эта сумма никак не будет учитываться.

     * **Наложенный платеж** — дополнительная сумма, которую покупатель платит продавцу при получении заказа.

       .. fancybox:: img/sdek_shipment_form_1.png
           :alt: Форма создания отгрузки СДЭК в CS-Cart.
 
   * Вкладка **Позвонить адресату**:  введите данные для уведомления покупателя о поступлении заказа; если не указывать время доставки, то данные с этой вкладки учтены не будут.

     .. fancybox:: img/sdek_shipment_form_2.png
         :alt: Форма создания отгрузки СДЭК в CS-Cart.

   * Вкладка **Вызов курьера**: введите данные для курьерской доставки; если не задать время ожидания курьера, то данные с этой вкладки учтены не будут.

     .. fancybox:: img/sdek_shipment_form_3.png
         :alt: Форма создания отгрузки СДЭК в CS-Cart.

#. Когда вы заполните данные во всех вкладках, нажмите кнопку **Сохранить**. Информация будет передана в СДЭК, а на странице заказа в CS-Cart появится номер отслеживания. Рядом со статусом доставки будет иконка редактирования. С ее помощью вы сможете изменить данные на вкладках **Позвонить адресату** и **Вызов курьера**, если возникнет необходимость.

     .. fancybox:: img/sdek_shipment_status.png
         :alt: Номер отслеживания отгрузки СДЭК в CS-Cart.

.. warning::

    Если удалить отгрузку или заказ в CS-Cart, то информация о соответствующих им отгрузках СДЭК не будет удалена. Вам необходимо будет удалить отгрузку в личном кабинете СДЭК.

Часто задаваемые вопросы
========================

* Как посмотреть квитанцию отгрузки СДЭК?

  Для просмотра квитанции отгрузки СДЭК откройте нужную отгрузку, нажмите на шестерёнку и выберите пункт **Квитанция** в выпадающем меню.

  .. fancybox:: img/sdek_document.png
      :alt: Получение квитанции СДЭК в CS-Cart.
    
* Почему возникла ошибка *"Сумма НДС не соответствует указанной ставке НДС"*?

  Ошибка "Сумма НДС не соответствует указанной ставке НДС" отображается, когда налоги указаны неверно. Например, если администратор указал налоговую ставку 0%, а настроил - 18%.